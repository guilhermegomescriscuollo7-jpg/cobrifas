<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo | COBRIFAS</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ffcc00;
            --primary-glow: rgba(255, 204, 0, 0.5);
            --bg-dark: #050505;
            --glass-bg: rgba(20, 20, 20, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --white: #ffffff;
            --text-muted: #aaaaaa;
            --red: #ff4444;
            --green: #00ff66;
            --blue: #00a2ff;
            --orange: #ffaa00;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 15% 50%, rgba(255, 204, 0, 0.08) 0%, transparent 25%),
                url('https://images8.alphacoders.com/132/1328325.png');
            background-attachment: fixed; background-size: cover;
            color: var(--white); font-family: 'Rajdhani', sans-serif;
            height: 100vh; overflow: hidden;
        }

        .admin-wrapper { display: grid; grid-template-columns: 260px 1fr; height: 100vh; }

        /* SIDEBAR */
        aside {
            background: rgba(5, 5, 5, 0.95); backdrop-filter: blur(20px);
            border-right: var(--glass-border); padding: 30px 20px;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .logo-adm { font-family: 'Orbitron'; font-size: 1.8rem; text-align: center; color: var(--primary); margin-bottom: 50px; text-shadow: 0 0 15px var(--primary-glow); }
        .nav-menu { display: flex; flex-direction: column; gap: 12px; }
        .nav-link {
            padding: 16px 20px; border-radius: 8px; cursor: pointer; transition: 0.3s;
            font-family: 'Orbitron'; font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted);
            display: flex; align-items: center; gap: 15px; border: 1px solid transparent;
        }
        .nav-link:hover, .nav-link.active { background: rgba(255, 204, 0, 0.1); color: var(--primary); border-color: rgba(255, 204, 0, 0.3); }

        /* MAIN */
        main { padding: 40px; overflow-y: auto; }
        .header-title { font-family: 'Orbitron'; font-size: 1.8rem; margin-bottom: 40px; display: flex; align-items: center; gap: 20px; text-transform: uppercase; }
        .header-title::before { content: ''; width: 8px; height: 30px; background: var(--primary); border-radius: 4px; box-shadow: 0 0 15px var(--primary); }

        .tab-content { display: none; animation: fadeInUp 0.5s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(25px); border: var(--glass-border); border-radius: 12px; padding: 30px; margin-bottom: 30px; }

        /* TABLES */
        table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        th { text-align: left; padding: 15px 20px; font-family: 'Orbitron'; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; }
        td { background: rgba(255,255,255,0.03); padding: 15px 20px; border-top: var(--glass-border); border-bottom: var(--glass-border); vertical-align: middle; }
        tr td:first-child { border-radius: 10px 0 0 10px; border-left: 3px solid var(--primary); }
        tr td:last-child { border-radius: 0 10px 10px 0; }

        .user-cell { display: flex; align-items: center; gap: 12px; }
        .user-img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary); object-fit: cover; }

        /* BUTTONS */
        .btn-action { padding: 8px 12px; border: none; border-radius: 4px; font-family: 'Orbitron'; font-size: 0.6rem; cursor: pointer; transition: 0.3s; margin-right: 5px; font-weight: bold; }
        .btn-green { background: var(--green); color: #000; }
        .btn-red { background: rgba(255, 68, 68, 0.1); color: var(--red); border: 1px solid var(--red); }
        .btn-red:hover { background: var(--red); color: #fff; }
        .btn-blue { background: rgba(0, 162, 255, 0.15); color: var(--blue); border: 1px solid var(--blue); }
        .btn-blue:hover { background: var(--blue); color: #fff; }
        .btn-orange { background: rgba(255, 170, 0, 0.15); color: var(--orange); border: 1px solid var(--orange); }
        .btn-orange:hover { background: var(--orange); color: #fff; }
        .btn-gold { background: var(--primary); color: #000; box-shadow: 0 0 15px rgba(255,204,0,0.4); text-transform: uppercase; font-weight: 900; }
        .btn-gold:hover { transform: scale(1.05); }

        /* MODAL SORTEIO */
        #modalSorteio { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.98); z-index:5000; align-items:center; justify-content:center; backdrop-filter: blur(15px); }
        .sorteio-card { text-align: center; width: 100%; max-width: 550px; padding: 40px; border: 2px solid var(--primary); border-radius: 20px; background: #000; box-shadow: 0 0 80px rgba(255,204,0,0.2); position: relative; }
        .sorteio-title { font-family: 'Orbitron'; color: #fff; font-size: 1.5rem; margin-bottom: 20px; letter-spacing: 2px; }
        .sorteio-numero { font-size: 7rem; font-family: 'Orbitron'; color: var(--primary); text-shadow: 0 0 40px var(--primary); margin: 10px 0; font-weight: 900; line-height: 1; }
        .winner-info { margin-top: 30px; border-top: 1px dashed #333; padding-top: 20px; display: none; }
        .winner-label { font-size: 0.8rem; color: #888; font-family: 'Orbitron'; letter-spacing: 1px; margin-bottom: 5px; }
        .winner-name { font-size: 1.8rem; color: #fff; font-family: 'Rajdhani'; font-weight: bold; text-transform: uppercase; margin-bottom: 15px; }
        .winner-details { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .detail-item b { display: block; color: var(--primary); font-size: 0.7rem; font-family: 'Orbitron'; }
        .detail-item span { color: #ccc; font-family: 'Rajdhani'; font-size: 1.1rem; }
        .btn-confirm-winner { background: var(--green); color: #000; font-family: 'Orbitron'; font-weight: 900; width: 100%; padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; text-transform: uppercase; margin-top: 10px; }
        .btn-confirm-winner:hover { box-shadow: 0 0 20px var(--green); }

        /* INPUTS & STATS */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--glass-bg); padding: 30px; border-radius: 12px; border: var(--glass-border); text-align: center; }
        .stat-val { font-family: 'Orbitron'; font-size: 2rem; color: var(--primary); font-weight: 900; }
        .input-group { margin-bottom: 20px; }
        label { display:block; color:var(--primary); font-size:0.7rem; margin-bottom:8px; font-family:'Orbitron'; }
        input, textarea, select { width:100%; padding:15px; background:rgba(0,0,0,0.5); border:1px solid #333; color:#fff; border-radius: 6px; font-family: 'Rajdhani'; }
        .btn-save { width:100%; padding:15px; background:var(--primary); border:none; font-weight:900; cursor:pointer; font-family: 'Orbitron'; color: #000; border-radius: 6px; margin-top: 10px; }
        .bonus-section { background: rgba(255, 204, 0, 0.05); border: 1px dashed var(--primary); padding: 20px; border-radius: 8px; margin-bottom: 20px; display: none; }

        /* --- CHAT LAYOUT (WhatsApp Style) --- */
        .chat-layout { display: grid; grid-template-columns: 300px 1fr; height: 600px; background: rgba(0, 0, 0, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; overflow: hidden; }
        .chat-sidebar { background: rgba(0, 0, 0, 0.8); border-right: 1px solid rgba(255, 255, 255, 0.1); overflow-y: auto; }
        .contact-item { padding: 15px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); cursor: pointer; transition: 0.3s; }
        .contact-item:hover, .contact-item.active { background: rgba(255, 204, 0, 0.1); border-left: 3px solid var(--primary); }
        .contact-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #333; }
        .contact-info b { display: block; color: #fff; font-size: 0.9rem; }
        .contact-info span { font-size: 0.7rem; color: #888; }
        .chat-main { display: flex; flex-direction: column; background-color: rgba(20, 20, 20, 0.95); }
        .chat-header { padding: 15px; background: rgba(0, 0, 0, 0.9); border-bottom: 1px solid rgba(255, 255, 255, 0.1); font-family: 'Orbitron'; color: var(--primary); }
        .chat-messages-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg-bubble { max-width: 70%; padding: 10px 15px; border-radius: 10px; font-size: 0.9rem; position: relative; word-wrap: break-word; font-family: 'Rajdhani'; }
        .msg-user { align-self: flex-start; background: #333; color: #fff; border-bottom-left-radius: 0; }
        .msg-admin { align-self: flex-end; background: var(--primary); color: #000; border-bottom-right-radius: 0; font-weight: 600; }
        .msg-time { font-size: 0.6rem; opacity: 0.6; text-align: right; margin-top: 4px; }
        .chat-input-area { padding: 15px; background: rgba(0, 0, 0, 0.9); display: flex; gap: 10px; }
    </style>
</head>
<body>

    <div class="admin-wrapper">
        <aside>
            <div>
                <div class="logo-adm">COB<span>ADM</span></div>
                <nav class="nav-menu">
                    <div class="nav-link active" onclick="openTab(event, 'dash')">üìä DASHBOARD</div>
                    <div class="nav-link" onclick="openTab(event, 'membros')">üë• MEMBROS</div>
                    <div class="nav-link" onclick="openTab(event, 'pagamentos')">üí∏ PAGAMENTOS</div>
                    <div class="nav-link" onclick="openTab(event, 'rifas')">‚ö° RIFAS</div>
                    <div class="nav-link" onclick="openTab(event, 'pix')">üîë CHAVE PIX</div>
                    <div class="nav-link" onclick="openTab(event, 'chat')">üí¨ CHAT</div>
                </nav>
            </div>
            <div class="nav-link" onclick="location.href='index.html'" style="color:var(--red);">üö™ SAIR</div>
        </aside>

        <main>
            <section id="dash" class="tab-content active">
                <div class="header-title">VIS√ÉO GERAL</div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-val" id="countMembros">0</div><div style="font-size:0.8rem; color:#666; font-family:'Orbitron';">MEMBROS TOTAIS</div></div>
                    <div class="stat-card"><div class="stat-val" id="countRifas">0</div><div style="font-size:0.8rem; color:#666; font-family:'Orbitron';">RIFAS ATIVAS</div></div>
                    <div class="stat-card"><div class="stat-val" id="totalVendas">R$ 0,00</div><div style="font-size:0.8rem; color:#666; font-family:'Orbitron';">VENDAS APROVADAS</div></div>
                </div>
            </section>

            <section id="membros" class="tab-content">
                <div class="header-title">GERENCIAR MEMBROS</div>
                <div class="glass-panel">
                    <table>
                        <thead><tr><th>MEMBRO</th><th>STATUS / CARGO</th><th>TELEFONE</th><th>CPF</th><th>A√á√ïES</th></tr></thead>
                        <tbody id="listaMembrosBody"></tbody>
                    </table>
                </div>
            </section>

            <section id="pagamentos" class="tab-content">
                <div class="header-title">APROVAR PAGAMENTOS</div>
                <div style="margin-bottom:20px;">
                    <button class="btn-action btn-green" onclick="simularVenda()">+ Simular Venda Teste</button>
                </div>
                <div class="glass-panel">
                    <table>
                        <thead><tr><th>MEMBRO</th><th>RIFA</th><th>VALOR / COTAS</th><th>COMPROVANTE</th><th>A√á√ÉO</th></tr></thead>
                        <tbody id="listaPagamentos"></tbody>
                    </table>
                </div>
            </section>

            <section id="rifas" class="tab-content">
                <div class="header-title">GERENCIAR RIFAS</div>
                
                <div class="glass-panel">
                    <h3 style="font-family:'Orbitron'; margin-bottom:20px; color:#888;">NOVA RIFA</h3>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                        <input type="text" id="rifaNome" placeholder="Nome da Skin">
                        <input type="text" id="rifaImg" placeholder="URL da Imagem">
                        <input type="number" id="rifaPreco" placeholder="Pre√ßo (R$)">
                        <input type="number" id="rifaTotal" placeholder="Total Cotas">
                    </div>
                    <div style="margin-bottom:20px;"><label style="cursor:pointer; display:flex; align-items:center; gap:10px;"><input type="checkbox" id="checkBonus" onchange="toggleBonus()" style="width:auto;"> ADICIONAR PR√äMIO TOP COMPRADOR?</label></div>
                    <div class="bonus-section" id="bonusFields">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                            <input type="text" id="bNome" placeholder="Nome do Item B√¥nus">
                            <input type="text" id="bImg" placeholder="URL Imagem B√¥nus">
                        </div>
                    </div>
                    <button class="btn-save" onclick="addRifa()">CRIAR RIFA</button>
                </div>

                <div id="listaRifasAdm"></div>
            </section>

            <section id="pix" class="tab-content">
                <div class="header-title">CONFIGURAR CHAVE PIX</div>
                <div class="glass-panel" style="max-width: 500px;">
                    <div class="input-group">
                        <label>TIPO DE CHAVE</label>
                        <select id="pixTipo">
                            <option value="CPF">CPF</option>
                            <option value="CNPJ">CNPJ</option>
                            <option value="EMAIL">E-mail</option>
                            <option value="TELEFONE">Telefone</option>
                            <option value="ALEATORIA">Chave Aleat√≥ria</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>CHAVE PIX</label>
                        <input type="text" id="pixChave" placeholder="Digite sua chave aqui...">
                    </div>
                    <button class="btn-save" onclick="salvarPix()">SALVAR CONFIGURA√á√ÉO</button>
                </div>
            </section>

            <section id="chat" class="tab-content">
                <div class="header-title">SUPORTE AO CLIENTE</div>
                <div class="chat-layout">
                    <div class="chat-sidebar" id="listaContatos"></div>
                    <div class="chat-main">
                        <div class="chat-header" id="chatHeaderName">SELECIONE UM MEMBRO</div>
                        <div class="chat-messages-area" id="chatMessagesBox">
                            <div style="text-align:center; color:#555; margin-top:100px;">Clique em um contato ao lado para ver a conversa.</div>
                        </div>
                        <div class="chat-input-area">
                            <input type="text" id="respAdm" placeholder="Digite sua resposta..." disabled>
                            <button class="btn-action btn-green" onclick="responderChat()" id="btnEnviarChat" disabled>ENVIAR</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="modalSorteio">
        <div class="sorteio-card">
            <div class="sorteio-title" id="sorteioItemName">ITEM SORTEADO</div>
            <div id="sorteioNumero" class="sorteio-numero">---</div>
            <div id="winnerContainer" class="winner-info">
                <div class="winner-label">VENCEDOR:</div>
                <div class="winner-name" id="winName">CARREGANDO...</div>
                <div class="winner-details">
                    <div class="detail-item"><b>CPF</b><span id="winCpf">***.***.***-**</span></div>
                    <div class="detail-item"><b>TELEFONE</b><span id="winTel">(**) *****-****</span></div>
                </div>
                <button class="btn-confirm-winner" onclick="document.getElementById('modalSorteio').style.display='none'; renderRifas();">CONFIRMAR E ENCERRAR</button>
            </div>
        </div>
    </div>

    <script>
        function openTab(e, id) {
            document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(x => x.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            e.currentTarget.classList.add('active');
            if(id === 'membros') renderMembros();
            if(id === 'dash') updateDash();
            if(id === 'pagamentos') renderPagamentos();
            if(id === 'rifas') renderRifas();
            if(id === 'chat') renderChat();
            if(id === 'pix') carregarPix();
        }

        /* --- PIX --- */
        function salvarPix() {
            localStorage.setItem('configPix', JSON.stringify({
                tipo: document.getElementById('pixTipo').value,
                chave: document.getElementById('pixChave').value
            }));
            alert("Chave PIX atualizada!");
        }
        function carregarPix() {
            const c = JSON.parse(localStorage.getItem('configPix')) || {};
            if(c.tipo) document.getElementById('pixTipo').value = c.tipo;
            if(c.chave) document.getElementById('pixChave').value = c.chave;
        }

        /* --- MEMBROS --- */
        function renderMembros() {
            const membros = JSON.parse(localStorage.getItem('membros')) || [];
            const container = document.getElementById('listaMembrosBody');
            if(membros.length === 0) { container.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px;">Vazio.</td></tr>'; return; }
            container.innerHTML = membros.map((m, i) => {
                const isBanido = m.status === 'BANIDO', isAdmin = m.cargo === 'ADMIN', cor = isBanido?'var(--red)':'var(--green)';
                return `<tr style="opacity:${isBanido?'0.5':'1'}"><td><div class="user-cell"><img src="${m.avatar}" class="user-img"><div><b>${m.nome}</b><br><span style="font-size:0.7rem;color:var(--primary)">${m.nick||''}</span></div></div></td><td><span style="color:${isAdmin?'var(--blue)':'#fff'}">${m.cargo||'MEMBRO'}</span><br><span style="color:${cor};font-size:0.7rem;">${m.status||'ATIVO'}</span></td><td>${m.tel||'--'}</td><td>${m.cpf}</td><td><button class="btn-action btn-blue" onclick="editM(${i},'cargo')">ADMIN</button><button class="btn-action btn-orange" onclick="editM(${i},'status')">BANIR</button><button class="btn-action btn-red" onclick="delM(${i})">APAGAR</button></td></tr>`;
            }).join('');
        }
        function editM(i, f) {
            let l = JSON.parse(localStorage.getItem('membros'));
            if(f==='cargo') l[i].cargo = l[i].cargo === 'ADMIN' ? 'MEMBRO' : 'ADMIN';
            if(f==='status') l[i].status = l[i].status === 'BANIDO' ? 'ATIVO' : 'BANIDO';
            localStorage.setItem('membros', JSON.stringify(l)); renderMembros();
        }
        function delM(i) { if(confirm("Apagar?")) { let l=JSON.parse(localStorage.getItem('membros')); l.splice(i,1); localStorage.setItem('membros', JSON.stringify(l)); renderMembros(); updateDash(); } }

        /* --- RIFAS & SORTEIO --- */
        function toggleBonus() { document.getElementById('bonusFields').style.display = document.getElementById('checkBonus').checked ? 'block' : 'none'; }
        
        function addRifa() {
            const n=document.getElementById('rifaNome').value, i=document.getElementById('rifaImg').value, p=document.getElementById('rifaPreco').value, t=document.getElementById('rifaTotal').value;
            const b = document.getElementById('checkBonus').checked ? {nome:document.getElementById('bNome').value, img:document.getElementById('bImg').value} : null;
            if(!n||!i||!p||!t) return alert("Preencha tudo");
            let l=JSON.parse(localStorage.getItem('rifas'))||[];
            l.push({nome:n, img:i, preco:p, total:t, vendidas:0, bonus:b, numerosVendidos:[]});
            localStorage.setItem('rifas', JSON.stringify(l)); renderRifas(); updateDash();
        }

        function renderRifas() {
            const r=JSON.parse(localStorage.getItem('rifas'))||[];
            document.getElementById('listaRifasAdm').innerHTML = r.map((x,i) => {
                const temGanhador = x.ganhador ? true : false;
                const total = parseInt(x.total);
                const vendidos = x.numerosVendidos ? x.numerosVendidos.length : 0;
                const podeSortear = !temGanhador && vendidos >= total;
                const pct = (vendidos/total)*100;
                
                let statusHtml = `<div style="height:5px; background:#333; margin-top:5px; border-radius:3px;"><div style="width:${pct}%; background:var(--primary); height:100%;"></div></div><small style="color:#aaa;">Vendas: ${vendidos}/${total} (${pct.toFixed(0)}%)</small>`;
                let btnSorteio = '';
                
                if(temGanhador) {
                    statusHtml = `<div style="color:var(--green); font-size:0.7rem; font-weight:bold; margin-top:5px;">üèÜ VENCEDOR: ${x.ganhador.nome}</div>`;
                    btnSorteio = `<span style="color:#666; font-size:0.6rem;">FINALIZADA</span>`;
                } else if(podeSortear) {
                    btnSorteio = `<button class="btn-action btn-gold" onclick="abrirSorteio(${i})">SORTEAR</button>`;
                } else {
                    btnSorteio = `<span style="color:#666; font-size:0.6rem;">AGUARDANDO 100%</span>`;
                }

                return `<div style="background:rgba(255,255,255,0.05); padding:15px; margin-top:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;"><div style="display:flex; gap:15px; align-items:center;"><img src="${x.img}" style="width:60px; border-radius:4px;"><div style="min-width: 150px;"><b style="font-size:1rem;">${x.nome}</b>${statusHtml}</div></div><div style="display:flex; align-items:center; gap:10px;">${btnSorteio}<button class="btn-action btn-red" onclick="delRifa(${i})">EXCLUIR</button></div></div>`;
            }).join('');
        }

        function delRifa(i) {
            if(confirm("Excluir rifa?")) {
                let l=JSON.parse(localStorage.getItem('rifas')); l.splice(i,1); localStorage.setItem('rifas',JSON.stringify(l)); renderRifas();
            }
        }

        /* --- L√ìGICA DO SORTEIO --- */
        function abrirSorteio(idx) {
            const rifas = JSON.parse(localStorage.getItem('rifas'));
            const rifa = rifas[idx];
            document.getElementById('modalSorteio').style.display = 'flex';
            document.getElementById('sorteioItemName').innerText = "SORTEANDO: " + rifa.nome.toUpperCase();
            document.getElementById('winnerContainer').style.display = 'none';
            document.getElementById('sorteioNumero').style.display = 'block';
            let counter = 0;
            const interval = setInterval(() => {
                document.getElementById('sorteioNumero').innerText = Math.floor(Math.random() * rifa.total) + 1;
                counter++;
                if(counter > 30) { clearInterval(interval); realizarSorteio(idx); }
            }, 80);
        }

        function realizarSorteio(idx) {
            const rifas = JSON.parse(localStorage.getItem('rifas'));
            const rifa = rifas[idx];
            const vendidos = rifa.numerosVendidos;
            const randIndex = Math.floor(Math.random() * vendidos.length);
            const numeroVencedor = vendidos[randIndex];
            
            const pagamentos = JSON.parse(localStorage.getItem('pagamentos')) || [];
            const membros = JSON.parse(localStorage.getItem('membros')) || [];
            
            const pagamentoVencedor = pagamentos.find(p => p.numeros && p.numeros.includes(numeroVencedor));
            let nomeGanhador="Erro", cpfGanhador="---", telGanhador="---";

            if(pagamentoVencedor) {
                const membroVencedor = membros.find(m => m.cpf === pagamentoVencedor.cpf);
                if(membroVencedor) {
                    nomeGanhador = membroVencedor.nome;
                    cpfGanhador = mascararCPF(membroVencedor.cpf);
                    telGanhador = mascararTel(membroVencedor.tel);
                } else {
                    nomeGanhador = pagamentoVencedor.usuario;
                }
            }

            document.getElementById('sorteioNumero').innerText = numeroVencedor;
            document.getElementById('winName').innerText = nomeGanhador;
            document.getElementById('winCpf').innerText = cpfGanhador;
            document.getElementById('winTel').innerText = telGanhador;
            document.getElementById('winnerContainer').style.display = 'block';

            rifas[idx].ganhador = { nome: nomeGanhador, numero: numeroVencedor, cpf: cpfGanhador };
            localStorage.setItem('rifas', JSON.stringify(rifas));
        }

        function mascararCPF(cpf) { if(!cpf) return "***"; return cpf.substring(0, 3) + ".***.***-" + cpf.substring(cpf.length - 2); }
        function mascararTel(tel) { if(!tel) return "***"; return "(" + tel.substring(0, 2) + ") *****-" + tel.substring(tel.length - 4); }

        /* --- DASHBOARD --- */
        function updateDash() {
            const m=JSON.parse(localStorage.getItem('membros'))||[], r=JSON.parse(localStorage.getItem('rifas'))||[], p=JSON.parse(localStorage.getItem('pagamentos'))||[];
            let total=0; p.filter(x=>x.status==='aprovado').forEach(x=>total+=parseFloat(x.valor));
            document.getElementById('countMembros').innerText=m.length; document.getElementById('countRifas').innerText=r.length; document.getElementById('totalVendas').innerText=`R$ ${total.toFixed(2)}`;
        }
        function renderPagamentos() {
            const p=JSON.parse(localStorage.getItem('pagamentos'))||[];
            document.getElementById('listaPagamentos').innerHTML = p.filter(x=>x.status==='pendente').map((x) => {
                let compHtml = x.comprovante ? `<a href="${x.comprovante}" download="comprovante.png" style="color:var(--primary); font-size:0.7rem;">BAIXAR</a>` : '---';
                return `<tr><td><b>${x.usuario}</b><br><small>${x.cpf}</small></td><td>${x.rifa}</td><td>R$ ${x.valor} (${x.cotas})</td><td>${compHtml}</td><td><button class="btn-action btn-green" onclick="procPag(${x.id},'aprovado','${x.rifa}',${x.cotas})">APROVAR</button><button class="btn-action btn-red" onclick="procPag(${x.id},'recusado')">RECUSAR</button></td></tr>`;
            }).join('')||'<tr><td colspan="5" style="text-align:center; padding:30px;">Vazio.</td></tr>';
        }
        function simularVenda() { let p=JSON.parse(localStorage.getItem('pagamentos'))||[]; p.push({id:Date.now(), usuario:"Simulado", cpf:"000", rifa:"Teste", valor:"10.00", cotas:1, status:"pendente"}); localStorage.setItem('pagamentos',JSON.stringify(p)); renderPagamentos(); }
        function procPag(id,s,n,q){
            let p=JSON.parse(localStorage.getItem('pagamentos')), r=JSON.parse(localStorage.getItem('rifas'));
            const i=p.findIndex(x=>x.id===id); if(i!==-1) p[i].status=s;
            if(s==='aprovado'&&r){ const ri=r.findIndex(x=>x.nome===n); if(ri!==-1 && !r[ri].numerosVendidos) r[ri].numerosVendidos = []; localStorage.setItem('rifas',JSON.stringify(r)); }
            localStorage.setItem('pagamentos',JSON.stringify(p)); renderPagamentos(); updateDash();
        }

        /* --- CHAT (WHATSAPP STYLE) --- */
        let chatSelecionadoCPF = null;
        function renderChat() {
            const logs = JSON.parse(localStorage.getItem('chatLog')) || [];
            const membros = JSON.parse(localStorage.getItem('membros')) || [];
            const cpfsComMensagens = [...new Set(logs.map(log => log.userCpf))];
            const containerContatos = document.getElementById('listaContatos');
            if (cpfsComMensagens.length === 0) { containerContatos.innerHTML = '<div style="padding:20px; color:#666; text-align:center;">Nenhuma conversa.</div>'; return; }
            containerContatos.innerHTML = cpfsComMensagens.map(cpf => {
                const membro = membros.find(m => m.cpf === cpf) || { nome: 'Desconhecido', avatar: 'https://cdn-icons-png.flaticon.com/512/149/149071.png' };
                const msgsUsuario = logs.filter(l => l.userCpf === cpf);
                const ultimaMsg = msgsUsuario[msgsUsuario.length - 1].text.substring(0, 30) + '...';
                const activeClass = (chatSelecionadoCPF === cpf) ? 'active' : '';
                return `<div class="contact-item ${activeClass}" onclick="abrirConversa('${cpf}', '${membro.nome}')"><img src="${membro.avatar}" class="contact-avatar"><div class="contact-info"><b>${membro.nome}</b><span>${ultimaMsg}</span></div></div>`;
            }).join('');
            if (chatSelecionadoCPF) renderizarMensagensDoChat();
        }
        function abrirConversa(cpf, nome) {
            chatSelecionadoCPF = cpf;
            document.getElementById('chatHeaderName').innerText = nome.toUpperCase();
            document.getElementById('respAdm').disabled = false;
            document.getElementById('btnEnviarChat').disabled = false;
            renderChat(); renderizarMensagensDoChat();
        }
        function renderizarMensagensDoChat() {
            const logs = JSON.parse(localStorage.getItem('chatLog')) || [];
            const box = document.getElementById('chatMessagesBox');
            const conversa = logs.filter(l => l.userCpf === chatSelecionadoCPF);
            box.innerHTML = conversa.map(msg => `<div class="msg-bubble ${msg.from === 'admin' ? 'msg-admin' : 'msg-user'}">${msg.text}<div class="msg-time">${msg.time}</div></div>`).join('');
            box.scrollTop = box.scrollHeight;
        }
        function responderChat() {
            const input = document.getElementById('respAdm');
            const texto = input.value.trim();
            if (!texto || !chatSelecionadoCPF) return;
            let logs = JSON.parse(localStorage.getItem('chatLog')) || [];
            logs.push({ userCpf: chatSelecionadoCPF, from: 'admin', text: texto, time: new Date().toLocaleTimeString().slice(0, 5) });
            localStorage.setItem('chatLog', JSON.stringify(logs));
            input.value = ''; renderChat();
        }
        setInterval(() => { if(document.getElementById('chat').classList.contains('active')) { renderChat(); } }, 3000);

        window.onload = updateDash;
    </script>
</body>
</html>