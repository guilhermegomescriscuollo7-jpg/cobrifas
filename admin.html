<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Admin | COBRIFAS</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        body { background: #050505; color: #fff; font-family: sans-serif; display: grid; grid-template-columns: 200px 1fr; height: 100vh; }
        aside { background: #000; padding: 20px; border-right: 1px solid #333; }
        .menu-item { padding: 10px; cursor: pointer; color: #888; }
        .menu-item.active { color: #ffcc00; }
        main { padding: 40px; overflow-y: auto; }
        .card { background: #0f0f0f; padding: 20px; margin-bottom: 20px; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #222; }
    </style>
</head>
<body>
    <aside>
        <h2 style="color:#ffcc00; font-family:Orbitron; margin-bottom:30px;">COB-ADM</h2>
        <div class="menu-item active" onclick="tab('pag')">PAGAMENTOS</div>
        <div class="menu-item" onclick="tab('rif')">RIFAS</div>
        <div class="menu-item" onclick="tab('cha')">CHAT</div>
    </aside>
    <main>
        <section id="pag" class="tab">
            <h2>Pagamentos Pendentes</h2>
            <table id="tablePag"><thead><tr><th>User</th><th>Rifa</th><th>Valor</th><th>Ação</th></tr></thead><tbody id="bodyPag"></tbody></table>
        </section>
        <section id="rif" class="tab" style="display:none">
            <h2>Criar Rifa</h2>
            <input type="text" id="rn" placeholder="Nome">
            <input type="text" id="ri" placeholder="URL Imagem">
            <input type="number" id="rp" placeholder="Preço">
            <input type="number" id="rt" placeholder="Total">
            <button onclick="addR()">CRIAR</button>
            <div id="listR"></div>
        </section>
    </main>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyBfX7oMSNn4gSL1Knfx-yvwBwkX4H7JjQg", authDomain: "cobrifas.firebaseapp.com", projectId: "cobrifas", storageBucket: "cobrifas.firebasestorage.app", messagingSenderId: "1098617388770", appId: "1:1098617388770:web:8b6124a9ece62c9f81a8bb" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function tab(id) { document.querySelectorAll('.tab').forEach(t => t.style.display='none'); document.getElementById(id).style.display='block'; }

        db.ref('pagamentos').on('value', s => {
            const pags = s.val() || {};
            document.getElementById('bodyPag').innerHTML = Object.keys(pags).filter(id => pags[id].status === 'pendente').map(id => {
                const p = pags[id];
                return `<tr><td>${p.usuario}</td><td>${p.rifa}</td><td>R$ ${p.valor}</td><td><button onclick="aprovar('${id}','${p.rifaId}',${p.cotas})">OK</button></td></tr>`;
            }).join('');
        });

        function aprovar(pid, rid, qtd) {
            db.ref('rifas/'+rid).once('value', s => {
                const r = s.val();
                let nums = r.numerosVendidos || [];
                const novos = [];
                while(novos.length < qtd) {
                    let n = Math.floor(Math.random()*r.total)+1;
                    let fmt = String(n).padStart(3,'0');
                    if(!nums.includes(fmt) && !novos.includes(fmt)) novos.push(fmt);
                }
                db.ref('rifas/'+rid).update({ vendidas: (r.vendidas||0)+qtd, numerosVendidos: [...nums, ...novos] });
                db.ref('pagamentos/'+pid).update({ status: 'aprovado', numeros: novos });
            });
        }

        function addR() { db.ref('rifas').push({ nome: document.getElementById('rn').value, img: document.getElementById('ri').value, preco: document.getElementById('rp').value, total: document.getElementById('rt').value }); }
    </script>
</body>
</html>
