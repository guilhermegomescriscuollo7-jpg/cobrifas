<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Conta | COBRIFAS</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #ffcc00;
            --primary-glow: rgba(255, 204, 0, 0.5);
            --bg-dark: #050505;
            --card-bg: #0f0f0f;
            --glass: rgba(20, 20, 20, 0.95);
            --red: #ff4444;
            --green: #00ff66;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 10%, rgba(255, 204, 0, 0.05) 0%, transparent 50%),
                url('https://images8.alphacoders.com/132/1328325.png');
            background-attachment: fixed; background-size: cover;
            color: #fff; font-family: 'Rajdhani', sans-serif;
            overflow-x: hidden;
        }

        /* --- HEADER --- */
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 8%; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(15px); border-bottom: 2px solid var(--primary); position: sticky; top: 0; z-index: 1000; }
        .logo { font-family: 'Orbitron'; font-size: 1.8rem; font-weight: 900; color: #fff; text-decoration: none; }
        .logo span { color: var(--primary); text-shadow: 0 0 10px var(--primary); }
        .nav-user { display: flex; gap: 5px; align-items: center; }
        .nav-item { text-decoration: none; font-family: 'Orbitron'; font-weight: bold; font-size: 0.65rem; padding: 10px 15px; border-radius: 2px; transition: 0.4s; text-transform: uppercase; color: #888; cursor: pointer; border: 1px solid transparent; }
        .nav-item:hover, .nav-item.active { color: var(--primary); border-color: rgba(255,204,0,0.3); background: rgba(255, 204, 0, 0.05); }
        
        .cart-count-wrapper { position:relative; cursor:pointer; margin: 0 15px; display: flex; align-items: center; }
        .cart-icon-btn { font-size: 1.2rem; color: var(--primary); }
        .cart-count { position: absolute; top: -8px; right: -8px; background: var(--red); color: #fff; font-size: 0.6rem; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        
        .user-header-profile { display: flex; align-items: center; gap: 12px; margin: 0 15px; cursor: pointer; }
        .user-avatar-circle { width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--primary); object-fit: cover; }
        .user-name-header { font-family: 'Orbitron'; font-size: 0.75rem; color: var(--primary); text-transform: uppercase; font-weight: 900; }
        .btn-exit { color: var(--red); border: 1px solid var(--red); padding: 8px 18px; font-family: 'Orbitron'; font-weight: bold; font-size: 0.65rem; cursor: pointer; border-radius: 2px; transition: 0.3s; }
        .btn-exit:hover { background: var(--red); color: #fff; }

        /* --- SIDEBAR CARRINHO --- */
        #cartSidebar { position: fixed; top: 0; right: -400px; width: 400px; height: 100vh; background: var(--glass); border-left: 2px solid var(--primary); z-index: 2000; padding: 30px; transition: 0.5s ease; display: flex; flex-direction: column; backdrop-filter: blur(20px); }
        #cartSidebar.open { right: 0; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }

        /* --- LAYOUT GERAL --- */
        .container { padding: 40px 8%; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .section-title { font-family: 'Orbitron'; font-size: 1.5rem; margin-bottom: 40px; display: flex; align-items: center; gap: 15px; text-transform: uppercase; }
        .section-title::before { content: '‚ö°'; color: var(--primary); }

        /* --- CARDS RIFAS --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; }
        .card { background: var(--card-bg); border: 1px solid rgba(255,255,255,0.05); border-bottom: 4px solid var(--red); padding: 25px; border-radius: 4px; position: relative; transition: 0.3s; display: flex; flex-direction: column; }
        .price-badge { position: absolute; top: 0; right: 0; background: var(--primary); color: #000; font-weight: 900; font-family: 'Orbitron'; padding: 8px 25px; font-size: 1rem; clip-path: polygon(10% 0, 100% 0, 100% 100%, 0 100%); }
        .skin-img { width: 100%; height: 160px; object-fit: contain; margin: 20px 0; align-self: center; }
        .progress-bg { background: rgba(255,255,255,0.05); height: 6px; border-radius: 3px; overflow: hidden; margin-bottom: 20px; }
        .progress-fill { background: linear-gradient(90deg, #333, var(--primary)); height: 100%; transition: 0.5s; }
        .btn-participar { width: 100%; padding: 12px; background: transparent; border: 1px solid var(--primary); color: var(--primary); font-family: 'Orbitron'; font-weight: 900; text-transform: uppercase; cursor: pointer; transition: 0.3s; margin-top: auto; }
        .btn-participar:hover { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary-glow); }

        /* --- AJUSTE EDITAR PERFIL (FIX) --- */
        .glass-panel { background: var(--glass); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 40px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .input-group { display: flex; flex-direction: column; gap: 8px; }
        label { color: var(--primary); font-family: 'Orbitron'; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; }
        input { width: 100%; padding: 12px; background: #000; border: 1px solid #333; color: #fff; border-radius: 4px; font-family: 'Rajdhani'; font-size: 1rem; }
        input:focus { border-color: var(--primary); outline: none; }
        .avatar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 15px; margin-top: 20px; }
        .avatar-opt { width: 70px; height: 70px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; transition: 0.3s; object-fit: cover; background: #222; }
        .avatar-opt.selected { border-color: var(--primary); box-shadow: 0 0 10px var(--primary-glow); }

        /* --- RANKINGS --- */
        .rankings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 40px; margin-top: 60px; }
        .rank-card { background: var(--glass); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; padding: 30px; }
        .rank-title { font-family: 'Orbitron'; font-size: 1rem; color: #fff; text-transform: uppercase; margin-bottom: 25px; border-bottom: 2px solid rgba(255,255,255,0.05); padding-bottom: 15px; }
        .rank-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; background: rgba(0,0,0,0.3); border-radius: 6px; border-left: 3px solid #444; margin-bottom: 10px; }

        /* --- MODAIS --- */
        #modalCotas, #modalPix, #modalVictory, #modalDetails { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:4000; align-items:center; justify-content:center; backdrop-filter: blur(5px); }
        .modal-card { background: #151515; border: 1px solid #333; width: 90%; max-width: 600px; border-radius: 12px; padding: 30px; position: relative; }
        .victory-card { text-align: center; width: 100%; max-width: 500px; padding: 40px; border: 2px solid var(--primary); border-radius: 20px; background: #000; box-shadow: 0 0 100px var(--primary); animation: popIn 0.5s ease; }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .ticket-number { background: var(--primary); color: #000; font-family: 'Orbitron'; font-weight: 900; font-size: 0.75rem; padding: 5px 10px; border-radius: 4px; display: inline-block; margin: 3px; }
    </style>
</head>
<body>

    <header>
        <a href="index.html" class="logo">COB<span>RIFAS</span></a>
        <nav class="nav-user">
            <div class="nav-item active" onclick="openTab(event, 'loja')">Loja</div>
            <div class="nav-item" onclick="openTab(event, 'minhas')">Minhas Rifas</div>
            <div class="nav-item" onclick="openTab(event, 'suporte')">Suporte</div>
            <div class="nav-item" onclick="openTab(event, 'perfil')">Perfil</div>
            <div class="cart-count-wrapper" onclick="toggleCart()">
                <div class="cart-icon-btn">üõí</div>
                <div class="cart-count" id="cartCount">0</div>
            </div>
            <div class="user-header-profile" onclick="openTab(event, 'perfil')">
                <img src="" id="headAvatar" class="user-avatar-circle">
                <span id="headName" class="user-name-header"></span>
            </div>
            <div class="btn-exit" onclick="logout()">SAIR</div>
        </nav>
    </header>

    <div class="container">
        <section id="loja" class="tab-content active">
            <h2 class="section-title">RIFAS ATIVAS</h2>
            <div class="grid" id="gridLoja"></div>
            <div class="rankings-grid">
                <div class="rank-card">
                    <div class="rank-title">üèÜ GANHADORES RECENTES</div>
                    <div id="recentWinnersList"></div>
                </div>
                <div class="rank-card">
                    <div class="rank-title">üíé TOP MEMBROS</div>
                    <div id="globalRankingList"></div>
                </div>
            </div>
        </section>

        <section id="minhas" class="tab-content">
            <h2 class="section-title">MINHAS PARTICIPA√á√ïES</h2>
            <div id="listaParticipacoes"></div>
        </section>

        <section id="suporte" class="tab-content">
            <h2 class="section-title">CHAT DE SUPORTE</h2>
            <div class="glass-panel">
                <div id="chatBox" style="height:400px; overflow-y:auto; margin-bottom:20px; display:flex; flex-direction:column; gap:10px;"></div>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="msgInput" placeholder="Sua d√∫vida...">
                    <button class="btn-participar" style="width:auto; padding:0 30px;" onclick="enviarMsg()">ENVIAR</button>
                </div>
            </div>
        </section>

        <section id="perfil" class="tab-content">
            <h2 class="section-title">MEU PERFIL</h2>
            <div class="glass-panel">
                <div class="form-grid">
                    <div class="input-group">
                        <label>NOME COMPLETO</label>
                        <input type="text" id="editNome">
                    </div>
                    <div class="input-group">
                        <label>NICK (EXIBI√á√ÉO)</label>
                        <input type="text" id="editNick">
                    </div>
                    <div class="input-group">
                        <label>TELEFONE</label>
                        <input type="text" id="editTel">
                    </div>
                    <div class="input-group">
                        <label>CPF (BLOQUEADO)</label>
                        <input type="text" id="dispCpf" disabled style="opacity:0.4; cursor:not-allowed;">
                    </div>
                    <div class="input-group">
                        <label>NOVA SENHA</label>
                        <input type="password" id="editPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div class="input-group">
                        <label>CONFIRMAR SENHA</label>
                        <input type="password" id="editConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                </div>
                <div class="avatar-selection">
                    <label>ESCOLHA SEU √çCONE:</label>
                    <div class="avatar-grid" id="avatarGrid"></div>
                </div>
                <button class="btn-participar" style="margin-top:40px; background:var(--primary); color:#000;" onclick="salvarPerfil()">
                    SALVAR ALTERA√á√ïES
                </button>
            </div>
        </section>
    </div>

    <div id="modalCotas">
        <div class="modal-card">
            <span class="close-modal" onclick="document.getElementById('modalCotas').style.display='none'">√ó</span>
            <div class="modal-title">Escolha a quantidade de t√≠tulos:</div>
            <div class="cotas-grid" id="cotasGrid"></div>
            <div class="action-row">
                <div class="qtd-input-wrapper">
                    <button class="qtd-btn" onclick="adjustQtd(-1)">-</button>
                    <input type="number" class="qtd-display" id="inputQtd" value="10">
                    <button class="qtd-btn" onclick="adjustQtd(1)">+</button>
                </div>
                <button class="btn-confirmar" onclick="confirmarAdicaoCarrinho()">
                    <span id="btnTotalValor">R$ 0,00</span>
                </button>
            </div>
        </div>
    </div>

    <div id="modalVictory">
        <div class="victory-card">
            <span style="font-size:5rem;">üèÜ</span>
            <h1 style="color:var(--primary); font-family:'Orbitron';">VOC√ä GANHOU!</h1>
            <p id="vicItemName" style="font-size:1.5rem; margin:15px 0; font-weight:bold;"></p>
            <p>N√∫mero sorteado: <b id="vicNumber" style="color:var(--primary); font-size:2rem;"></b></p>
            <button class="btn-participar" style="background:var(--primary); color:#000; margin-top:20px;" onclick="document.getElementById('modalVictory').style.display='none'">RESGATAR PR√äMIO</button>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBfX7oMSNn4gSL1Knfx-yvwBwkX4H7JjQg",
            authDomain: "cobrifas.firebaseapp.com",
            projectId: "cobrifas",
            storageBucket: "cobrifas.firebasestorage.app",
            messagingSenderId: "1098617388770",
            appId: "1:1098617388770:web:8b6124a9ece62c9f81a8bb"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let userAtivo = null, carrinho = [], avatarTemp = "";
        let rifaSelecionadaId = null, precoUnitario = 0;
        const avatares = ["https://cdn-icons-png.flaticon.com/512/149/149071.png", "https://cdn-icons-png.flaticon.com/512/3135/3135715.png", "https://cdn-icons-png.flaticon.com/512/4333/4333609.png", "https://cdn-icons-png.flaticon.com/512/236/236831.png", "https://cdn-icons-png.flaticon.com/512/4140/4140048.png", "https://cdn-icons-png.flaticon.com/512/6997/6997662.png"];

        function init() {
            const sessao = JSON.parse(localStorage.getItem('sessaoAtiva'));
            if (!sessao) { window.location.href = 'index.html'; return; }

            db.ref('membros').orderByChild('cpf').equalTo(sessao.cpf).on('value', s => {
                const membros = s.val();
                if(membros) {
                    const id = Object.keys(membros)[0];
                    userAtivo = membros[id];
                    userAtivo.firebaseId = id;
                    document.getElementById('headName').innerText = userAtivo.nick || userAtivo.nome.split(' ')[0];
                    document.getElementById('headAvatar').src = userAtivo.avatar || avatares[0];
                    document.getElementById('editNome').value = userAtivo.nome;
                    document.getElementById('editNick').value = userAtivo.nick || "";
                    document.getElementById('editTel').value = userAtivo.tel || "";
                    document.getElementById('dispCpf').value = userAtivo.cpf;
                    avatarTemp = userAtivo.avatar || avatares[0];
                    renderAvatares();
                }
            });

            carregarLoja(); carregarMinhasRifas(); carregarChat(); checkVitorias();
        }

        function carregarLoja() {
            db.ref('rifas').on('value', s => {
                const rifas = s.val() || {};
                const grid = document.getElementById('gridLoja');
                const ativas = Object.keys(rifas).filter(id => !rifas[id].ganhador);
                grid.innerHTML = ativas.map(id => {
                    const r = rifas[id];
                    const pct = ((r.vendidas || 0) / r.total) * 100;
                    return `<div class="card"><div class="price-badge">R$ ${r.preco}</div><img src="${r.img}" class="skin-img"><h3>${r.nome}</h3><div class="progress-bg"><div class="progress-fill" style="width: ${pct}%"></div></div><button class="btn-participar" onclick="abrirModalCompra('${id}', ${r.preco}, ${r.total}, ${r.vendidas || 0})">PARTICIPAR</button></div>`;
                }).join('');
            });
        }

        function salvarPerfil() {
            const p1 = document.getElementById('editPass').value;
            if(p1 && p1 !== document.getElementById('editConfirm').value) return alert("Senhas n√£o conferem!");
            const up = { nome: document.getElementById('editNome').value, nick: document.getElementById('editNick').value, tel: document.getElementById('editTel').value, avatar: avatarTemp };
            if(p1) up.pass = p1;
            db.ref('membros/' + userAtivo.firebaseId).update(up).then(() => alert("Perfil salvo!"));
        }

        function checkVitorias() {
            db.ref('rifas').on('value', s => {
                const rifas = s.val() || {};
                Object.values(rifas).forEach(r => {
                    if(r.ganhador && r.ganhador.cpf === userAtivo.cpf && !r.ganhador.visto) {
                        document.getElementById('vicItemName').innerText = r.nome;
                        document.getElementById('vicNumber').innerText = "#" + r.ganhador.numero;
                        document.getElementById('modalVictory').style.display = 'flex';
                    }
                });
            });
        }

        function openTab(e, id) { document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function toggleCart() { document.getElementById('cartSidebar').classList.toggle('open'); }
        function renderAvatares() { const grid = document.getElementById('avatarGrid'); grid.innerHTML = avatares.map(url => `<img src="${url}" class="avatar-opt ${avatarTemp === url ? 'selected' : ''}" onclick="avatarTemp='${url}'; renderAvatares();">`).join(''); }
        function logout() { localStorage.clear(); window.location.href = 'index.html'; }

        window.onload = init;
    </script>
</body>
</html>
