<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Minha Conta | COBRIFAS</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #ffcc00; --bg: #050505; --card: #0f0f0f; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg); color: #fff; font-family: 'Rajdhani'; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 8%; background: #000; border-bottom: 2px solid var(--primary); sticky; top: 0; }
        .nav-item { color: #888; cursor: pointer; font-family: 'Orbitron'; font-size: 0.7rem; padding: 10px; }
        .nav-item.active { color: var(--primary); }
        .container { padding: 40px 8%; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        /* CORRE√á√ÉO DO PERFIL */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .input-group { display: flex; flex-direction: column; gap: 8px; }
        label { color: var(--primary); font-family: 'Orbitron'; font-size: 0.65rem; }
        input { padding: 12px; background: #000; border: 1px solid #333; color: #fff; border-radius: 4px; }
        /* CHAT */
        #chatBox { height: 350px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #000; padding: 15px; border-radius: 8px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 8px; position: relative; }
        #modalVictory { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:5000; align-items:center; justify-content:center; }
    </style>
</head>
<body>
    <header>
        <div style="font-family:Orbitron; font-weight:900;">COB<span style="color:var(--primary)">RIFAS</span></div>
        <nav style="display:flex; gap:10px;">
            <div class="nav-item active" onclick="tab('loja')">LOJA</div>
            <div class="nav-item" onclick="tab('minhas')">MINHAS RIFAS</div>
            <div class="nav-item" onclick="tab('suporte')">CHAT</div>
            <div class="nav-item" onclick="tab('perfil')">PERFIL</div>
            <div class="nav-item" onclick="logout()" style="color:red">SAIR</div>
        </nav>
    </header>

    <div class="container">
        <section id="loja" class="tab-content active"><div id="gridLoja" class="grid"></div></section>
        <section id="minhas" class="tab-content"><div id="minhasRifas"></div></section>
        <section id="suporte" class="tab-content">
            <div id="chatBox"></div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <input type="text" id="chatIn" style="flex:1">
                <button onclick="sendMsg()" style="padding:10px 20px; background:var(--primary); border:none;">ENVIAR</button>
            </div>
        </section>
        <section id="perfil" class="tab-content">
            <div class="form-grid">
                <div class="input-group"><label>NOME</label><input type="text" id="pNome"></div>
                <div class="input-group"><label>NICK</label><input type="text" id="pNick"></div>
                <div class="input-group"><label>TELEFONE</label><input type="text" id="pTel"></div>
                <div class="input-group"><label>CPF</label><input type="text" id="pCpf" disabled></div>
                <div class="input-group"><label>NOVA SENHA</label><input type="password" id="pPass"></div>
            </div>
            <button onclick="saveP()" style="margin-top:20px; padding:15px; background:var(--primary); border:none; width:100%; font-family:Orbitron;">SALVAR</button>
        </section>
    </div>

    <div id="modalVictory"><div style="text-align:center; padding:50px; border:2px solid var(--primary); background:#000;">
        <h1 style="color:var(--primary); font-family:Orbitron;">üèÜ VOC√ä GANHOU!</h1>
        <p id="vicItem" style="font-size:1.5rem; margin:20px 0;"></p>
        <button onclick="document.getElementById('modalVictory').style.display='none'" style="padding:10px 20px; background:var(--primary); border:none;">FECHAR</button>
    </div></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBfX7oMSNn4gSL1Knfx-yvwBwkX4H7JjQg", authDomain: "cobrifas.firebaseapp.com", projectId: "cobrifas", storageBucket: "cobrifas.firebasestorage.app", messagingSenderId: "1098617388770", appId: "1:1098617388770:web:8b6124a9ece62c9f81a8bb" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let userAtivo = JSON.parse(localStorage.getItem('sessaoAtiva'));
        if(!userAtivo) location.href='index.html';

        function tab(id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
            if(id === 'suporte') loadChat();
        }

        db.ref('rifas').on('value', s => {
            const rifas = s.val() || {};
            document.getElementById('gridLoja').innerHTML = Object.keys(rifas).filter(id => !rifas[id].ganhador).map(id => {
                const r = rifas[id];
                return `<div class="card"><img src="${r.img}" style="width:100%; height:120px; object-fit:contain;"><h3>${r.nome}</h3><button onclick="comprar('${id}','${r.nome}',${r.preco})" style="width:100%; background:var(--primary); border:none; margin-top:10px; padding:8px;">R$ ${r.preco}</button></div>`;
            }).join('');
            Object.values(rifas).forEach(r => { if(r.ganhador && r.ganhador.cpf === userAtivo.cpf && !r.ganhador.visto) { document.getElementById('vicItem').innerText = r.nome; document.getElementById('modalVictory').style.display='flex'; db.ref(`rifas/${r.nome}/ganhador`).update({visto:true}); } });
        });

        function comprar(id, nome, preco) {
            const qtd = prompt("Quantas cotas?", "10");
            if(qtd) db.ref('pagamentos').push({ usuario: userAtivo.nome, cpf: userAtivo.cpf, rifa: nome, rifaId: id, valor: (preco*qtd).toFixed(2), cotas: qtd, status: 'pendente', data: new Date().toLocaleString() });
        }

        function loadChat() {
            db.ref('chatLog').orderByChild('userCpf').equalTo(userAtivo.cpf).on('value', s => {
                const msgs = Object.values(s.val() || {});
                document.getElementById('chatBox').innerHTML = msgs.map(m => `<div style="align-self:${m.from==='user'?'flex-end':'flex-start'}; background:${m.from==='user'? 'var(--primary)':'#333'}; color:${m.from==='user'?'#000':'#fff'}; padding:8px; border-radius:5px; max-width:80%;">${m.text}</div>`).join('');
                document.getElementById('chatBox').scrollTop = 9999;
            });
        }
        function sendMsg() { const t = document.getElementById('chatIn').value; if(t) db.ref('chatLog').push({ userCpf: userAtivo.cpf, from: 'user', text: t, time: new Date().toLocaleTimeString() }); document.getElementById('chatIn').value=''; }

        function saveP() {
            db.ref('membros').orderByChild('cpf').equalTo(userAtivo.cpf).once('value', s => {
                const id = Object.keys(s.val())[0];
                const up = { nome: document.getElementById('pNome').value, nick: document.getElementById('pNick').value, tel: document.getElementById('pTel').value };
                if(document.getElementById('pPass').value) up.pass = document.getElementById('pPass').value;
                db.ref('membros/'+id).update(up).then(() => alert("Salvo!"));
            });
        }
        function logout() { localStorage.clear(); location.href='index.html'; }
        window.onload = () => { document.getElementById('pNome').value = userAtivo.nome; document.getElementById('pCpf').value = userAtivo.cpf; };
    </script>
</body>
</html>
