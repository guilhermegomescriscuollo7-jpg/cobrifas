<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Minha Conta | COBRIFAS</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<style>
:root{--primary:#ffcc00;--bg-dark:#050505;--card-bg:#0f0f0f;--glass:rgba(20,20,20,.95);--red:#ff4444;--green:#00ff66;--btn-orange:#f1b44c;}
*{margin:0;padding:0;box-sizing:border-box}
body{background:#050505 url('https://images8.alphacoders.com/132/1328325.png');background-size:cover;color:#fff;font-family:'Rajdhani'}
header{display:flex;justify-content:space-between;align-items:center;padding:15px 8%;background:#000;border-bottom:2px solid var(--primary)}
.logo{font-family:Orbitron;color:#fff;text-decoration:none}
.logo span{color:var(--primary)}
.nav-item{cursor:pointer;margin-right:10px}
.tab-content{display:none;padding:20px}
.tab-content.active{display:block}

#cartSidebar{position:fixed;right:-400px;top:0;width:350px;height:100vh;background:#111;border-left:2px solid var(--primary);transition:.3s;padding:20px;z-index:3000}
#cartSidebar.open{right:0}

#modalCotas,#modalPix{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);align-items:center;justify-content:center;z-index:5000}

.modal-card-cota,.modal-card-pix{background:#111;padding:20px;border-radius:10px;width:95%;max-width:600px;border:2px solid var(--primary)}

.cota-item{background:#000;padding:10px;margin:5px;border:1px solid #333;cursor:pointer;text-align:center}
.cota-item.active{border-color:var(--primary);background:#222}

.btn-action{padding:10px 15px;border:1px solid var(--primary);background:transparent;color:var(--primary);cursor:pointer;margin-top:10px}
.btn-action:hover{background:var(--primary);color:#000}
</style>
</head>
<body>

<header>
<a class="logo">COB<span>RIFAS</span></a>
<div>
<span class="nav-item" onclick="tab('loja')">Loja</span>
<span class="nav-item" onclick="tab('minhas')">Minhas</span>
<span class="nav-item" onclick="tab('suporte')">Suporte</span>
<span class="nav-item" onclick="tab('perfil')">Perfil</span>
<span class="nav-item" onclick="toggleCart()">ðŸ›’ <b id="cartCount">0</b></span>
</div>
</header>

<div id="cartSidebar">
<h3>Carrinho</h3>
<div id="cartList"></div>
<div id="cartTotal"></div>
<button class="btn-action" onclick="abrirCheckoutPix()">Finalizar</button>
<button class="btn-action" onclick="toggleCart()">Fechar</button>
</div>

<div id="loja" class="tab-content active">
<h2>Rifas</h2>
<div id="gridLoja"></div>
</div>

<div id="minhas" class="tab-content">
<h2>Minhas Rifas</h2>
<div id="listaMinhasRifas"></div>
</div>

<div id="suporte" class="tab-content">
<h2>Suporte</h2>
<div id="chatBox"></div>
<input id="chatInput"><button onclick="enviarMsg()">Enviar</button>
</div>

<div id="perfil" class="tab-content">
<h2>Perfil</h2>
<input id="pNome"><input id="pTel">
<button onclick="saveP()">Salvar</button>
</div>

<!-- MODAL COTAS -->
<div id="modalCotas" onclick="if(event.target.id=='modalCotas')fecharCotas()">
<div class="modal-card-cota">
<h3>Escolha cotas</h3>
<div id="listaCotas"></div>
<input id="inQtd" type="number" value="10" readonly>
<div id="totalModal"></div>
<button class="btn-action" onclick="addCarrinho()">Adicionar</button>
</div>
</div>

<!-- MODAL PIX -->
<div id="modalPix" onclick="if(event.target.id=='modalPix')fecharPix()">
<div class="modal-card-pix">
<h3>Pagamento PIX</h3>
<div id="txtChavePix"></div>
<input type="file" id="compInput" onchange="validarArquivo()">
<button id="btnFinalizarPix" class="btn-action" onclick="enviarPedidoFirebase()">JÃ¡ paguei</button>
</div>
</div>

<script>
const firebaseConfig={apiKey:"AIzaSyBfX7oMSNn4gSL1Knfx-yvwBwkX4H7JjQg",authDomain:"cobrifas.firebaseapp.com",projectId:"cobrifas",databaseURL:"https://cobrifas-default-rtdb.firebaseio.com"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let userAtivo=null,userFirebaseId=null,carrinho=[];
let rifaSelId=null,precoUnico=0,estoqueSel=0,comprovanteBase64=null;

function tab(id){document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));document.getElementById(id).classList.add('active');}
function toggleCart(){document.getElementById('cartSidebar').classList.toggle('open');}
function fecharCotas(){modalCotas.style.display='none'}
function fecharPix(){modalPix.style.display='none'}

function carregarPagina(){
const sessao=JSON.parse(localStorage.getItem('sessaoAtiva')||'null');
if(!sessao)return;

loadLoja();
loadMinhas();
loadChat();
}

function loadLoja(){
db.ref('rifas').on('value',s=>{
const rifas=s.val()||{};
const g=document.getElementById('gridLoja');
g.innerHTML='';
Object.keys(rifas).forEach(id=>{
const r=rifas[id];
const div=document.createElement('div');
div.innerHTML=`<b>${r.nome}</b> - R$ ${r.preco} <button onclick="openModal('${id}',${r.preco},${r.total-r.vendidas})">Cotas</button>`;
g.appendChild(div);
});
});}

function openModal(id,preco,estoque){
rifaSelId=id;precoUnico=preco;estoqueSel=estoque;
const l=document.getElementById('listaCotas');l.innerHTML='';
[10,50,100,500].forEach(q=>{
const d=document.createElement('div');d.className='cota-item';d.innerText=q+' = R$'+(q*preco);
d.onclick=()=>setQtd(q);
l.appendChild(d);
});
inQtd.value=10;refreshTotal();
modalCotas.style.display='flex';
}

function setQtd(n){if(n<=estoqueSel){inQtd.value=n;refreshTotal();}}
function refreshTotal(){totalModal.innerText='R$ '+(inQtd.value*precoUnico).toFixed(2);}

function addCarrinho(){
carrinho.push({id:rifaSelId,preco:precoUnico,qtd:+inQtd.value});
updateUI();fecharCotas();toggleCart();
}

function updateUI(){
let t=0;
cartList.innerHTML=carrinho.map((c,i)=>{
t+=c.preco*c.qtd;
return `<div>${c.qtd}x - R$${c.preco*c.qtd} <span onclick="carrinho.splice(${i},1);updateUI()">x</span></div>`;
}).join('');
cartTotal.innerText='Total: R$'+t.toFixed(2);
cartCount.innerText=carrinho.length;
}

function abrirCheckoutPix(){
db.ref('config/pix/chave').once('value',s=>{
txtChavePix.innerText=s.val()||'sem chave';
modalPix.style.display='flex';
});}

function validarArquivo(){
const f=compInput.files[0];
if(!f)return;
const r=new FileReader();
r.onload=e=>{comprovanteBase64=e.target.result;};
r.readAsDataURL(f);
}

function enviarPedidoFirebase(){
carrinho.forEach(it=>{
db.ref('pagamentos').push({rifaId:it.id,qtd:it.qtd,valor:it.preco*it.qtd,status:'pendente',comprovante:comprovanteBase64});
});
carrinho=[];updateUI();fecharPix();alert('Enviado!');
}

function loadMinhas(){db.ref('pagamentos').on('value',s=>{listaMinhasRifas.innerHTML=JSON.stringify(s.val());});}
function loadChat(){db.ref('chatLog').on('value',s=>{chatBox.innerHTML=JSON.stringify(s.val());});}
function enviarMsg(){db.ref('chatLog').push({text:chatInput.value});chatInput.value='';}
function saveP(){alert('salvo fake');}

window.onload=carregarPagina;
</script>
</body></html>
