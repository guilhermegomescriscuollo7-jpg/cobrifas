<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Conta | COBRIFAS</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        /* MANTIDO SEU CSS ORIGINAL */
        :root {
            --primary: #ffcc00;
            --bg-dark: #050505;
            --card-bg: #0f0f0f;
            --glass: rgba(20, 20, 20, 0.95);
            --red: #ff4444;
            --green: #00ff66;
            --silver: #c0c0c0;
            --bronze: #cd7f32;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 10%, rgba(255, 204, 0, 0.05) 0%, transparent 50%),
                url('https://images8.alphacoders.com/132/1328325.png');
            background-attachment: fixed; background-size: cover;
            color: #fff; font-family: 'Rajdhani', sans-serif;
            overflow-x: hidden;
        }
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 8%; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(15px); border-bottom: 2px solid var(--primary); position: sticky; top: 0; z-index: 1000; }
        .logo { font-family: 'Orbitron'; font-size: 1.8rem; font-weight: 900; color: #fff; text-decoration: none; }
        .logo span { color: var(--primary); text-shadow: 0 0 10px var(--primary); }
        .nav-user { display: flex; gap: 5px; align-items: center; }
        .nav-item { text-decoration: none; font-family: 'Orbitron'; font-weight: bold; font-size: 0.65rem; padding: 10px 15px; border-radius: 2px; transition: 0.4s; text-transform: uppercase; color: #888; cursor: pointer; border: 1px solid transparent; }
        .nav-item:hover, .nav-item.active { color: var(--primary); border-color: rgba(255,204,0,0.3); background: rgba(255, 204, 0, 0.05); }
        .cart-icon-btn { font-size: 1.2rem; color: var(--primary); margin: 0 15px; cursor: pointer; position: relative; display: flex; align-items: center; }
        .cart-count { position: absolute; top: -8px; right: -8px; background: var(--red); color: #fff; font-size: 0.6rem; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .user-header-profile { display: flex; align-items: center; gap: 12px; margin: 0 15px; cursor: pointer; }
        .user-avatar-circle { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary); object-fit: cover; box-shadow: 0 0 10px var(--primary-glow); }
        .user-name-header { font-family: 'Orbitron'; font-size: 0.85rem; color: var(--primary); font-weight: 900; text-transform: uppercase; }
        .btn-exit { color: var(--red); border: 1px solid var(--red); padding: 8px 18px; font-family: 'Orbitron'; font-weight: bold; font-size: 0.65rem; cursor: pointer; border-radius: 2px; transition: 0.3s; }
        .btn-exit:hover { background: var(--red); color: #fff; }
        #cartSidebar { position: fixed; top: 0; right: -400px; width: 400px; height: 100vh; background: var(--glass); border-left: 2px solid var(--primary); z-index: 2000; padding: 30px; transition: 0.5s ease; display: flex; flex-direction: column; backdrop-filter: blur(20px); }
        #cartSidebar.open { right: 0; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .hero { padding: 80px 5% 40px; text-align: center; }
        .hero h1 { font-family: 'Orbitron'; font-size: clamp(2rem, 5vw, 4rem); font-style: italic; font-weight: 900; text-transform: uppercase; margin-bottom: 15px; }
        .hero h1 span { color: var(--primary); display: block; }
        .hero p { color: #888; font-size: 1rem; max-width: 600px; margin: 0 auto; }
        .ticker-wrap { width: 100%; overflow: hidden; background: rgba(0, 0, 0, 0.8); border-bottom: 1px solid #333; height: 40px; display: flex; align-items: center; }
        .ticker { display: inline-block; white-space: nowrap; padding-right: 100%; animation: ticker 40s linear infinite; }
        .ticker-item { display: inline-block; padding: 0 2rem; font-size: 0.9rem; color: #ccc; font-family: 'Orbitron'; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }
        .container { padding: 40px 8%; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .section-title { font-family: 'Orbitron'; font-size: 1.5rem; margin-bottom: 40px; display: flex; align-items: center; gap: 15px; text-transform: uppercase; }
        .section-title::before { content: '‚ö°'; color: var(--primary); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 30px; }
        .card { background: var(--card-bg); border: 1px solid rgba(255,255,255,0.05); border-bottom: 4px solid var(--red); padding: 25px; border-radius: 4px; position: relative; transition: 0.3s; display: flex; flex-direction: column; }
        .card:hover { transform: translateY(-5px); border-color: rgba(255,204,0,0.3); }
        .price-badge { position: absolute; top: 0; right: 0; background: var(--primary); color: #000; font-weight: 900; font-family: 'Orbitron'; padding: 8px 25px; font-size: 1rem; clip-path: polygon(10% 0, 100% 0, 100% 100%, 0 100%); }
        .skin-img { width: 100%; height: 160px; object-fit: contain; margin: 20px 0 10px; align-self: center; }
        .card h3 { font-family: 'Orbitron'; font-size: 1.1rem; text-align: center; margin-bottom: 20px; }
        .stats-row { display: flex; justify-content: space-between; font-size: 0.7rem; color: #666; margin-bottom: 5px; font-family: 'Orbitron'; font-weight: bold; }
        .progress-bg { background: rgba(255,255,255,0.05); height: 6px; border-radius: 3px; overflow: hidden; margin-bottom: 20px; }
        .progress-fill { background: linear-gradient(90deg, #333, var(--primary)); height: 100%; }
        .btn-participar { width: 100%; padding: 12px; background: transparent; border: 1px solid var(--primary); color: var(--primary); font-family: 'Orbitron'; font-weight: 900; text-transform: uppercase; cursor: pointer; transition: 0.3s; margin-top: auto; }
        .btn-participar:hover { background: var(--primary); color: #000; box-shadow: 0 0 15px rgba(255,204,0,0.4); }
        #modalCotas { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:4000; align-items:center; justify-content:center; backdrop-filter: blur(5px); }
        .modal-card { background: #151515; border: 1px solid #333; width: 90%; max-width: 600px; border-radius: 12px; padding: 30px; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #666; }
        .modal-title { font-family: 'Orbitron'; text-align: center; color: #fff; margin-bottom: 25px; font-size: 1rem; }
        .cotas-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
        .cota-btn { background: #000; border: 1px solid #333; border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
        .cota-btn:hover, .cota-btn.active { border-color: var(--primary); background: rgba(255, 204, 0, 0.05); }
        .cota-qtd { font-family: 'Orbitron'; font-size: 1.5rem; font-weight: 900; color: #fff; display: block; }
        .cota-preco { font-family: 'Rajdhani'; color: #888; font-size: 0.9rem; font-weight: bold; }
        .cota-select { font-size: 0.6rem; text-transform: uppercase; color: #666; margin-top: 5px; display: block; }
        .tag-popular { position: absolute; top: 0; left: 50%; transform: translateX(-50%); background: var(--primary); color: #000; font-size: 0.55rem; font-weight: bold; padding: 2px 10px; border-radius: 0 0 6px 6px; font-family: 'Orbitron'; }
        .action-row { display: flex; gap: 15px; align-items: center; }
        .qtd-input-wrapper { display: flex; align-items: center; background: #fff; border-radius: 6px; padding: 5px; flex: 1; justify-content: space-between; }
        .qtd-btn { width: 40px; height: 40px; border: none; background: transparent; font-size: 1.5rem; cursor: pointer; font-weight: bold; }
        .qtd-display { font-size: 1.2rem; font-weight: bold; border: none; text-align: center; width: 60px; outline: none; }
        .btn-confirmar { flex: 2; background: var(--primary); border: none; padding: 15px; border-radius: 6px; font-family: 'Rajdhani'; font-weight: bold; font-size: 1rem; cursor: pointer; display: flex; flex-direction: column; align-items: center; line-height: 1.2; }
        .btn-confirmar:hover { filter: brightness(1.1); }
        .btn-confirmar small { font-size: 0.8rem; font-weight: normal; }
        .ticket-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; }
        .ticket-number { background: var(--primary); color: #000; font-family: 'Orbitron'; font-weight: 900; font-size: 0.75rem; padding: 5px 10px; border-radius: 4px; display: inline-block; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .upload-label { display: flex; align-items: center; justify-content: center; gap: 10px; background: rgba(255,255,255,0.05); border: 1px dashed #666; padding: 15px; border-radius: 6px; cursor: pointer; transition: 0.3s; font-family: 'Orbitron'; font-size: 0.8rem; color: #aaa; }
        .btn-disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        .glass-panel { background: var(--glass); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 40px; }
        .rankings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 40px; margin-top: 60px; }
        .rank-card { background: var(--glass); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; padding: 30px; }
        .rank-title { font-family: 'Orbitron'; font-size: 1rem; color: #fff; text-transform: uppercase; margin-bottom: 25px; border-bottom: 2px solid rgba(255,255,255,0.05); padding-bottom: 15px; }
        .rank-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; background: rgba(0,0,0,0.3); border-radius: 6px; border-left: 3px solid #444; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
        .rank-item:hover { background: rgba(255,255,255,0.05); }
        .avatar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 15px; margin-top: 20px; }
        .avatar-opt { width: 70px; height: 70px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; transition: 0.3s; object-fit: cover; background: #222; }
        .avatar-opt.selected { border-color: var(--primary); box-shadow: 0 0 10px var(--primary-glow); }
        footer { text-align: center; padding: 60px; color: #444; font-family: 'Orbitron'; font-size: 0.7rem; border-top: 1px solid #111; margin-top: 40px; }
        #modalVictory { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:5000; align-items:center; justify-content:center; backdrop-filter: blur(10px); }
        .victory-card { text-align: center; width: 100%; max-width: 500px; padding: 40px; border: 2px solid var(--primary); border-radius: 20px; background: #000; box-shadow: 0 0 100px var(--primary); animation: popIn 0.5s ease; }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        #modalDetails { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:4500; align-items:center; justify-content:center; }
        .details-card { width: 90%; max-width: 400px; background: #111; border: 1px solid #333; padding: 30px; border-radius: 12px; }
        .detail-row { display: flex; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px dashed #333; padding-bottom: 8px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <header>
        <a href="index.html" class="logo">COB<span>RIFAS</span></a>
        <nav class="nav-user">
            <div class="nav-item active" onclick="openTab(event, 'loja')">Loja de Rifas</div>
            <div class="nav-item" onclick="openTab(event, 'minhas')">Minhas Rifas</div>
            <div class="nav-item" onclick="openTab(event, 'suporte')">Suporte Online</div>
            <div class="nav-item" onclick="openTab(event, 'perfil')">Editar Perfil</div>
            <div class="cart-count-wrapper" style="position:relative; cursor:pointer;" onclick="toggleCart()">
                <div class="cart-icon-btn">üõí</div>
                <div class="cart-count" id="cartCount">0</div>
            </div>
            <div class="user-header-profile" onclick="openTab(event, 'perfil')">
                <img src="" id="headAvatar" class="user-avatar-circle">
                <span id="headName" class="user-name-header"></span>
            </div>
            <div class="btn-exit" onclick="logout()">SAIR</div>
        </nav>
    </header>

    <div class="ticker-wrap"><div class="ticker" id="tickerContainer"></div></div>

    <div id="cartSidebar">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; font-family:'Orbitron';">
            <h3>CARRINHO</h3>
            <span style="cursor:pointer;" onclick="toggleCart()">‚úï FECHAR</span>
        </div>
        <div id="cartItemsList" style="flex:1; overflow-y:auto;"></div>
        <div style="padding-top:20px; border-top:1px solid var(--primary);">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; font-family:'Orbitron';"><span>TOTAL:</span><span id="cartTotalPrice" style="color:var(--primary);">R$ 0.00</span></div>
            <button class="btn-participar" style="background:var(--primary); color:#000;" onclick="finalizarPedido()">FINALIZAR PEDIDO (PIX)</button>
        </div>
    </div>

    <div id="heroMirror">
        <section class="hero">
            <h1 id="heroTitle">SUA PR√ìXIMA <span>SKIN DE ELITE</span></h1>
            <p id="heroDesc">Participe de sorteios r√°pidos e seguros com as melhores skins de Counter-Strike 2.</p>
        </section>
    </div>

    <div class="container">
        <section id="loja" class="tab-content active">
            <h2 class="section-title">VITRINE DE SKINS</h2>
            <div class="grid" id="gridLoja"></div>

            <div class="rankings-grid">
                <div class="rank-card">
                    <div class="rank-title">üèÜ GANHADORES RECENTES</div>
                    <div id="recentWinnersList"></div>
                </div>
                <div class="rank-card">
                    <div class="rank-title">üíé TOP MEMBROS</div>
                    <div id="globalRankingList"></div>
                </div>
            </div>
        </section>

        <section id="minhas" class="tab-content">
            <h2 class="section-title">MINHAS PARTICIPA√á√ïES</h2>
            <div class="glass-panel"><div id="listaParticipacoes"></div></div>
        </section>

        <section id="suporte" class="tab-content">
            <h2 class="section-title">CHAT DE SUPORTE</h2>
            <div class="glass-panel">
                <div id="chatBox" style="height:400px; overflow-y:auto; margin-bottom:20px; display:flex; flex-direction:column; gap:10px;"></div>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="msgInput" placeholder="Sua d√∫vida..." style="flex:1; padding:15px; background:#000; border:1px solid #333; color:#fff;">
                    <button class="btn-participar" style="width:auto; margin:0; padding:0 30px;" onclick="enviarMsg()">ENVIAR</button>
                </div>
            </div>
        </section>

        <section id="perfil" class="tab-content">
            <h2 class="section-title">MEU PERFIL</h2>
            <div class="glass-panel">
                <div class="form-grid">
                    <div><label>NOME COMPLETO</label><input type="text" id="editNome"></div>
                    <div><label>NICK</label><input type="text" id="editNick"></div>
                    <div><label>TELEFONE</label><input type="text" id="editTel"></div>
                    <div><label>CPF</label><input type="text" id="dispCpf" disabled style="opacity:0.4"></div>
                    <div><label>NOVA SENHA</label><input type="password" id="editPass"></div>
                    <div><label>CONFIRMAR SENHA</label><input type="password" id="editConfirm"></div>
                </div>
                <div class="avatar-selection"><label>ESCOLHA SEU √çCONE:</label><div class="avatar-grid" id="avatarGrid"></div></div>
                <button class="btn-participar" style="margin-top:40px; background:var(--primary); color:#000;" onclick="salvarPerfil()">SALVAR ALTERA√á√ïES</button>
            </div>
        </section>
    </div>

    <div id="modalCotas">
        <div class="modal-card">
            <span class="close-modal" onclick="document.getElementById('modalCotas').style.display='none'">√ó</span>
            <div class="modal-title">Quanto mais t√≠tulos, mais chances de ganhar!</div>
            <div class="cotas-grid" id="cotasGrid"></div>
            <div class="action-row">
                <div class="qtd-input-wrapper">
                    <button class="qtd-btn" onclick="adjustQtd(-1)">-</button>
                    <input type="number" class="qtd-display" id="inputQtd" value="10" onchange="updateTotal()">
                    <button class="qtd-btn" onclick="adjustQtd(1)">+</button>
                </div>
                <button class="btn-confirmar" onclick="confirmarAdicaoCarrinho()">
                    <small>Quero participar</small>
                    <span id="btnTotalValor">R$ 0,00</span>
                </button>
            </div>
        </div>
    </div>

    <div id="modalPix" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:4000; align-items:center; justify-content:center;">
        <div style="background:#111; border:2px solid var(--primary); padding:40px; border-radius:12px; text-align:center; max-width:450px; width:90%;">
            <h2 style="font-family:'Orbitron'; color:var(--primary); margin-bottom:20px;">PAGAMENTO PIX</h2>
            <div style="background:#222; padding:20px; border-radius:8px; margin:20px 0; border:1px solid #333; text-align:left;">
                <label style="color:var(--primary); font-size:0.7rem;">CHAVE PIX (<span id="txtTipoPix">---</span>)</label>
                <div id="txtChavePix" style="color:#fff; font-size:1.1rem; font-weight:bold; margin-bottom:15px;">---</div>
            </div>
            <div class="upload-area">
                <label for="comprovanteInput" class="upload-label">üìé ANEXAR COMPROVANTE</label>
                <input type="file" id="comprovanteInput" accept="image/*, application/pdf" style="display:none;" onchange="verificarComprovante()">
                <small id="fileNameDisplay" style="color:#888; display:block; margin-top:10px;">Nenhum arquivo selecionado</small>
            </div>
            <button id="btnConfirmarPag" class="btn-participar btn-disabled" style="background:var(--primary); color:#000; width:100%; margin-top:20px;" onclick="confirmarPixReal()">CONFIRMAR PAGAMENTO</button>
            <button class="btn-participar" style="background:transparent; border:1px solid #444; color:#888; margin-top:10px; width:100%;" onclick="document.getElementById('modalPix').style.display='none'">CANCELAR</button>
        </div>
    </div>

    <div id="modalVictory">
        <div class="victory-card">
            <span style="font-size:5rem;">üèÜ</span>
            <h1 style="color:var(--primary); font-family:'Orbitron'; margin-bottom:10px;">PARAB√âNS!</h1>
            <p style="color:#fff; font-size:1.2rem; margin-bottom:20px;">Voc√™ foi sorteado!</p>
            <div style="background:rgba(255,255,255,0.1); padding:20px; border-radius:10px; margin-bottom:20px;">
                <b id="vicItemName" style="font-size:1.5rem; display:block; color:#fff;">---</b>
                <small style="color:#aaa;">N√öMERO DA SORTE: <span id="vicNumber" style="color:var(--primary); font-weight:bold;">---</span></small>
            </div>
            <button class="btn-participar" style="background:var(--primary); color:#000;" onclick="fecharNotificacao()">RECEBER PR√äMIO</button>
        </div>
    </div>

    <div id="modalDetails">
        <div class="details-card">
            <h3 style="font-family:'Orbitron'; color:var(--primary); margin-bottom:20px;">RESULTADO</h3>
            <div class="detail-row"><span>ITEM:</span><b id="dtItem">---</b></div>
            <div class="detail-row"><span>DATA:</span><b id="dtData">---</b></div>
            <div class="detail-row"><span>N√öMERO:</span><b id="dtNum">---</b></div>
            <div class="detail-row"><span>GANHADOR:</span><b id="dtNome">---</b></div>
            <button class="btn-participar" style="margin-top:20px;" onclick="document.getElementById('modalDetails').style.display='none'">FECHAR</button>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBfX7oMSNn4gSL1Knfx-yvwBwkX4H7JjQg",
            authDomain: "cobrifas.firebaseapp.com",
            projectId: "cobrifas",
            storageBucket: "cobrifas.firebasestorage.app",
            messagingSenderId: "1098617388770",
            appId: "1:1098617388770:web:8b6124a9ece62c9f81a8bb"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let userAtivo = null, carrinho = [], avatarTemp = "";
        let rifaSelecionadaId = null, precoUnitario = 0;
        let comprovanteAtual = null;
        const avatares = ["https://cdn-icons-png.flaticon.com/512/149/149071.png", "https://cdn-icons-png.flaticon.com/512/3135/3135715.png", "https://cdn-icons-png.flaticon.com/512/4333/4333609.png", "https://cdn-icons-png.flaticon.com/512/236/236831.png", "https://cdn-icons-png.flaticon.com/512/4140/4140048.png", "https://cdn-icons-png.flaticon.com/512/6997/6997662.png"];

        function carregarDados() {
            const sessao = JSON.parse(localStorage.getItem('sessaoAtiva'));
            if (!sessao) { window.location.href = 'index.html'; return; }

            // Sincroniza dados do usu√°rio em tempo real do Firebase
            db.ref('membros').orderByChild('cpf').equalTo(sessao.cpf).on('value', s => {
                const membros = s.val();
                if(membros) {
                    const id = Object.keys(membros)[0];
                    userAtivo = membros[id];
                    userAtivo.firebaseId = id;
                    
                    document.getElementById('headName').innerText = userAtivo.nick || userAtivo.nome.split(' ')[0];
                    document.getElementById('headAvatar').src = userAtivo.avatar || avatares[0];
                    document.getElementById('editNome').value = userAtivo.nome;
                    document.getElementById('editNick').value = userAtivo.nick || "";
                    document.getElementById('editTel').value = userAtivo.tel || "";
                    document.getElementById('dispCpf').value = userAtivo.cpf;
                    avatarTemp = userAtivo.avatar || avatares[0];
                    renderAvatares();
                }
            });

            renderConfig();
            carregarLoja();
            carregarMinhasRifas();
            carregarGanhadores();
            carregarChat();
            carregarRankingGlobal();
            checkVitorias();
        }

        function carregarLoja() {
            db.ref('rifas').on('value', s => {
                const rifas = s.val() || {};
                const grid = document.getElementById('gridLoja');
                const ativas = Object.keys(rifas).filter(id => !rifas[id].ganhador);
                
                grid.innerHTML = ativas.map(id => {
                    const r = rifas[id];
                    const pct = ((r.vendidas || 0) / r.total) * 100;
                    return `
                        <div class="card">
                            <div class="price-badge">R$ ${r.preco}</div>
                            <img src="${r.img}" class="skin-img">
                            <h3>${r.nome}</h3>
                            <div class="stats-row"><span>RESTANTES:</span> <span>${r.total - (r.vendidas || 0)}</span></div>
                            <div class="progress-bg"><div class="progress-fill" style="width: ${pct}%"></div></div>
                            <button class="btn-participar" onclick="abrirModalCompra('${id}', ${r.preco}, ${r.total}, ${r.vendidas || 0})">PARTICIPAR</button>
                        </div>`;
                }).join('') || '<div style="grid-column:1/-1; text-align:center; padding:50px; color:#555;">Nenhuma rifa ativa.</div>';
            });
        }

        function abrirModalCompra(id, preco, total, vendidas) {
            rifaSelecionadaId = id;
            precoUnitario = preco;
            const restantes = total - vendidas;
            const grid = document.getElementById('cotasGrid');
            const opcoes = [10, 50, 100, 500, 1000].filter(o => o <= restantes);
            
            grid.innerHTML = opcoes.map(qtd => `
                <div class="cota-btn" onclick="selecionarQtd(${qtd})">
                    <span class="cota-qtd">+${qtd}</span>
                    <span class="cota-preco">R$ ${(qtd * preco).toFixed(2)}</span>
                </div>`).join('');
            
            document.getElementById('inputQtd').max = restantes;
            updateTotal();
            document.getElementById('modalCotas').style.display = 'flex';
        }

        function selecionarQtd(n) { document.getElementById('inputQtd').value = n; updateTotal(); }
        function adjustQtd(d) { let v = parseInt(document.getElementById('inputQtd').value) + d; if(v > 0) { document.getElementById('inputQtd').value = v; updateTotal(); } }
        function updateTotal() { document.getElementById('btnTotalValor').innerText = `R$ ${(parseInt(document.getElementById('inputQtd').value) * precoUnitario).toFixed(2)}`; }

        function confirmarAdicaoCarrinho() {
            const qtd = parseInt(document.getElementById('inputQtd').value);
            db.ref('rifas/' + rifaSelecionadaId).once('value', s => {
                const r = s.val();
                carrinho.push({ id: rifaSelecionadaId, nome: r.nome, preco: precoUnitario, qtd: qtd });
                atualizarCarrinhoUI();
                document.getElementById('modalCotas').style.display = 'none';
                toggleCart();
            });
        }

        function atualizarCarrinhoUI() {
            let total = 0, count = 0;
            document.getElementById('cartItemsList').innerHTML = carrinho.map((it, i) => {
                total += it.preco * it.qtd; count += it.qtd;
                return `<div class="cart-item"><div><b>${it.nome}</b><br><small>${it.qtd}x R$ ${it.preco}</small></div><span onclick="carrinho.splice(${i},1); atualizarCarrinhoUI();" style="cursor:pointer; color:red">‚úï</span></div>`;
            }).join('');
            document.getElementById('cartCount').innerText = count;
            document.getElementById('cartTotalPrice').innerText = `R$ ${total.toFixed(2)}`;
        }

        function finalizarPedido() {
            if(!carrinho.length) return;
            db.ref('config/pix').once('value', s => {
                const config = s.val() || {};
                document.getElementById('txtTipoPix').innerText = config.tipo || "---";
                document.getElementById('txtChavePix').innerText = config.chave || "---";
                document.getElementById('modalPix').style.display = 'flex';
            });
        }

        function verificarComprovante() {
            const file = document.getElementById('comprovanteInput').files[0];
            if(file) {
                document.getElementById('fileNameDisplay').innerText = file.name;
                const reader = new FileReader();
                reader.onload = e => { comprovanteAtual = e.target.result; document.getElementById('btnConfirmarPag').classList.remove('btn-disabled'); };
                reader.readAsDataURL(file);
            }
        }

        function confirmarPixReal() {
            carrinho.forEach(item => {
                db.ref('pagamentos').push({
                    usuario: userAtivo.nome, cpf: userAtivo.cpf,
                    rifa: item.nome, rifaId: item.id, cotas: item.qtd, 
                    valor: (item.preco * item.qtd).toFixed(2), 
                    status: 'pendente', comprovante: comprovanteAtual,
                    data: new Date().toLocaleString()
                });
            });
            carrinho = []; atualizarCarrinhoUI();
            document.getElementById('modalPix').style.display = 'none';
            alert("Pagamento enviado para aprova√ß√£o!");
        }

        function carregarMinhasRifas() {
            db.ref('pagamentos').orderByChild('cpf').equalTo(userAtivo.cpf).on('value', s => {
                const pags = s.val() || {};
                document.getElementById('listaParticipacoes').innerHTML = Object.values(pags).reverse().map(p => {
                    const cor = p.status === 'aprovado' ? 'var(--green)' : p.status === 'recusado' ? 'var(--red)' : '#888';
                    const nums = p.numeros ? p.numeros.map(n => `<span class="ticket-number">${n}</span>`).join('') : 'Aguardando aprova√ß√£o...';
                    return `
                        <div class="glass-panel" style="margin-bottom:20px; border-left:4px solid ${cor}">
                            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                                <b>${p.rifa}</b>
                                <span style="color:${cor}; font-weight:bold;">${p.status.toUpperCase()}</span>
                            </div>
                            <div class="ticket-grid">${nums}</div>
                        </div>`;
                }).join('') || '<div style="text-align:center; padding:30px; color:#555;">Nenhuma participa√ß√£o.</div>';
            });
        }

        function checkVitorias() {
            db.ref('rifas').on('value', s => {
                const rifas = s.val() || {};
                Object.keys(rifas).forEach(id => {
                    const r = rifas[id];
                    if(r.ganhador && r.ganhador.cpfReal === userAtivo.cpf && !r.ganhador.vistoPeloUser) {
                        document.getElementById('vicItemName').innerText = r.nome;
                        document.getElementById('vicNumber').innerText = r.ganhador.numero;
                        document.getElementById('modalVictory').style.display = 'flex';
                        db.ref(`rifas/${id}/ganhador`).update({ vistoPeloUser: true });
                    }
                });
            });
        }

        function carregarChat() {
            db.ref('chatLog').on('value', s => {
                const logs = Object.values(s.val() || {}).filter(m => m.userCpf === userAtivo.cpf);
                document.getElementById('chatBox').innerHTML = logs.map(m => `
                    <div style="align-self:${m.from==='user'?'flex-end':'flex-start'}; background:${m.from==='user'?'var(--primary)':'#333'}; color:${m.from==='user'?'#000':'#fff'}; padding:12px; border-radius:8px; max-width:75%; font-size:0.9rem;">
                        ${m.text}
                    </div>`).join('');
                document.getElementById('chatBox').scrollTop = 99999;
            });
        }

        function enviarMsg() {
            const txt = document.getElementById('msgInput').value.trim();
            if(!txt) return;
            db.ref('chatLog').push({ userCpf: userAtivo.cpf, from: 'user', text: txt, time: new Date().toLocaleTimeString() });
            document.getElementById('msgInput').value = '';
        }

        function salvarPerfil() {
            const p1 = document.getElementById('editPass').value;
            const p2 = document.getElementById('editConfirm').value;
            if(p1 && p1 !== p2) return alert("Senhas n√£o conferem!");

            const updates = {
                nome: document.getElementById('editNome').value,
                nick: document.getElementById('editNick').value,
                tel: document.getElementById('editTel').value,
                avatar: avatarTemp
            };
            if(p1) updates.pass = p1;

            db.ref('membros/' + userAtivo.firebaseId).update(updates).then(() => alert("Perfil atualizado!"));
        }

        // Fun√ß√µes auxiliares (Config, Ranking, UI)
        function carregarGanhadores() {
            db.ref('rifas').on('value', s => {
                const rifas = s.val() || {};
                const vencidos = Object.values(rifas).filter(r => r.ganhador).reverse().slice(0,5);
                document.getElementById('recentWinnersList').innerHTML = vencidos.map(r => `
                    <div class="rank-item" style="border-left-color:var(--green)">
                        <span>${r.ganhador.nome.split(' ')[0]}...<br><small>${r.nome}</small></span>
                        <b style="color:var(--primary)">#${r.ganhador.numero}</b>
                    </div>`).join('');
            });
        }

        function carregarRankingGlobal() {
            db.ref('pagamentos').on('value', s => {
                const pags = Object.values(s.val() || {}).filter(p => p.status === 'aprovado');
                const rank = {};
                pags.forEach(p => { rank[p.usuario] = (rank[p.usuario] || 0) + parseInt(p.cotas); });
                const sorted = Object.entries(rank).sort((a,b) => b[1] - a[1]).slice(0,5);
                document.getElementById('globalRankingList').innerHTML = sorted.map((u, i) => `
                    <div class="rank-item"><span>${i+1}. ${u[0]}</span><b>${u[1]} Cotas</b></div>`).join('');
            });
        }

        function renderConfig() { db.ref('configSite').once('value', s => { const c = s.val(); if(c) { document.getElementById('heroTitle').innerHTML = c.titulo; } }); }
        function openTab(e, id) { document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function fecharNotificacao() { document.getElementById('modalVictory').style.display = 'none'; }
        function toggleCart() { document.getElementById('cartSidebar').classList.toggle('open'); }
        function renderAvatares() { const grid = document.getElementById('avatarGrid'); grid.innerHTML = avatares.map(url => `<img src="${url}" class="avatar-opt ${avatarTemp === url ? 'selected' : ''}" onclick="avatarTemp='${url}'; renderAvatares();">`).join(''); }
        function logout() { localStorage.removeItem('sessaoAtiva'); window.location.href = 'index.html'; }

        window.onload = carregarDados;
    </script>
</body>
</html>
